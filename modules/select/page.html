<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball x balL</title>
  <link rel="stylesheet" href="assets/styles/common.css">
  <link rel="stylesheet" href="assets/styles/base.css">
  <link rel="stylesheet" href="assets/styles/select.css">
</head>
<body>
  <div id="main">
    <div id="player1">
      <div class="header">
        <div class="user-name"></div>  
      </div>
      <div class="selected-ball-container"></div>
      <div><button type="button" class="btn full ready-button" onclick="startGame()">Sẵn sàng</button></div>
    </div>
    <div id="ball">
      <div></div>
      <div class="header-title">VS</div>
      <div class="guide"></div>
      <div class="ball-container"></div>
      <div class="control-guide">
        <div class="control-guide-line">
          <div><div class="control-button">A</div> Trái</div>
          <div><div class="control-button">D</div> Phải</div>
          <div><div class="control-button">W</div> Tiến</div>
          <div><div class="control-button">S</div> Lùi</div>
        </div>
        <div class="control-guide-line">
          <div><div class="control-button">J</div> Skill 1</div>
          <div><div class="control-button">K</div> Skill 2</div>
          <div><div class="control-button">L</div> Skill 3</div>
          <div><div class="control-button">O</div> Skill cuối</div>
        </div>
      </div>
    </div>
    <div id="player2">
      <div class="header">
        <div class="user-name"></div>
      </div>
      <div class="selected-ball-container"></div>
      <div class="ready-status text-center"></div>
    </div>
  </div>
  <script src="libs/socket.io/socket.io.min.js"></script>
  <script src="assets/scripts/helper.js"></script>
  <script src="assets/scripts/index.js"></script>
  <bxb-script></bxb-script>
  <script>
    window.isPlayerReady = false;
    window.ball = false;
    window.players = {};

    function onSetup () {
      let ballTemplate = '';
      for (let i in window.BALLS) {
        ballTemplate += `
          <div class="ball-item" onclick="selectBall(${i}, this)">
            <img src="${window.BALLS[i].image}" />
          </div>
        `
      }

      document.querySelector('#ball .ball-container').innerHTML = ballTemplate;

      if (window.userId === window.roomId) {
        document.querySelector('#player1 .ready-button').innerHTML = 'Bắt đầu';
        document.querySelector('.guide').innerHTML = '* Lựa chọn nhân vật bóng, chờ đối thủ sẵn sàng và ấn nút "Bắt đầu" trận đấu.'
        document.querySelector('.ready-status').innerHTML = '<div class="ready-false">Chưa sẵn sàng</div>';
      } else {
        document.querySelector('.guide').innerHTML = '* Lựa chọn nhân vật bóng sau đó bấm vào nút "Sẵn sàng". Chờ đợi chủ phòng bắt đầu trận đấu.';
      }

      socket.on("connect", () => {
        socket.on('ROOM_DETAIL', (data) => {
          let template = ``;
          data.forEach(item => {
            if (!players[item.userId]) players[item.userId] = {
              userName: item.userName
            }

            if (window.userId === item.userId) {
              document.querySelector('#player1 .user-name').innerHTML = userName;
              return document.querySelector('#player1').setAttribute('user-id', item.userId);
            }
            document.querySelector('#player2 .user-name').innerHTML = item.userName
            return document.querySelector('#player2').setAttribute('user-id', item.userId);
          });
        })
      });

      socket.on('READY', () => {
        isPlayerReady = true;
        if (window.userId === window.roomId) {
          document.querySelector('.ready-status').innerHTML = '<div class="ready-true">Đã sẵn sàng</div>';
        }
      });

      socket.on('SELECT_BALL', (data) => {
        buildSelectBall(data.userId, data.ballId)
      });
    
      socket.on('START_GAME', () => {
        $helper.setCookie('players', JSON.stringify(players))
        window.location.href = '/game'
      });
    }
      
    function selectBall (id, self) {
      for (let element of document.querySelectorAll('.ball-item')) {
        element.classList.remove("active-1");
      }
      self.classList.add('active-1');
      socket.emit('SELECT_BALL', {
        userId: window.userId,
        ballId: id,
        roomId: roomId
      });
    }

    function buildSelectBall (userId, ballId) {
      const ball = window.BALLS[ballId];
      let skillTemplate = '';
      for(let skill of ball.skills) {
        skillTemplate += `
        <div class="skill-image"><img src="${skill.image}"></div>
        `
      }

      let template =  `
        <div class="selected-ball">
          <div class="ball-name">
            <div>${ball.name}</div>
            <div class="ball-nickname">${ball.nickname}</div>
          </div>
          <div class="ball-image"><img src="${ball.image}"></div>
          <table class="skill-table">
            <tr>
              <td class="skill-title"><img src="assets/images/hearts.svg"></td>
              <td>
                <div class="index-container">
                  <div class="index" style="width:${getIndexPercent('hp', ball.hp)}%"></div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="skill-title"><img src="assets/images/two-handed-sword.svg"></td>
              <td>
                <div class="index-container">
                  <div class="index" style="width:${getIndexPercent('strength', ball.strength)}%"></div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="skill-title"><img src="assets/images/arrow-dunk.svg"></td>
              <td>
                <div class="index-container">
                  <div class="index" style="width:${getIndexPercent('range', ball.range)}%"></div>
                </div>
              </td>
            </tr>
            <tr>
              <td class="skill-title"><img src="assets/images/run.svg"></td>
              <td>
                <div class="index-container">
                  <div class="index" style="width:${getIndexPercent('speed', ball.speed)}%"></div>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="2"><div class="skill">${skillTemplate}</div></td>
            </tr>
          </table>
        </div>
      `;

      document.querySelector(`[user-id="${userId}"] .selected-ball-container`).innerHTML = template;
      window.players[userId].ballId = ballId;
    }

    function getIndexPercent (type, value) {
      return value * 100 / 10;
    }

    function startGame () {
      if (window.userId == window.roomId) {
        if (!isPlayerReady) return false;
        for (let i in window.players) {
          if (!window.players[i].ballId) return false;
        }
        return socket.emit('START_GAME');
      }
      if (!window.players[userId].ballId) return false;
      document.querySelector('.ready-button').innerHTML = "Đã sẵn sàng";
      socket.emit('READY');
    }
  </script>
</body>
</html>